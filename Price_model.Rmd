---
title: "Price_model"
output: html_document
---

```{r}
library(knitr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(kableExtra)
library(stringr)
library(dplyr)
library(lubridate)
library(forecast)
library(tidyr)
library(purrr)

gas<-read.csv("Final_Data.csv")

gas_clean <- gas %>%
  mutate(
    Date     = as.Date(Date),
    Province = trimws(Province)
  ) %>%
  # 删掉 Province 为空的那一行
  filter(Province != "") %>%
  # 只保留 2017-01 到 2025-09 的样本
  filter(Date >= as.Date("2017-01-01"),
         Date <= as.Date("2025-09-01")) %>%
  # 你的研究里不包括 Quebec / Nunavut
  filter(!Province %in% c("Quebec", "Nunavut")) %>%
  arrange(Province, Date)

# 只保留模型真正要用到的变量，并去掉 NA
gas_model <- gas_clean %>%
  select(Province, Date,
         Gasoline_Price,
         Tax_cents_per_litre,
         Crude_Oil_Price,
         CPI_Gasoline) %>%
  drop_na()

#--------------------------------------------------
# 2. 定义一个“按省份拟合 ARIMAX”的函数
#    因变量：log(汽油价)
#    自变量：Carbon tax、原油价、汽油 CPI
#    时间结构：由 auto.arima 自动选 ARIMA(p,d,q)(P,D,Q)[12]
#--------------------------------------------------
fit_arimax_one_prov <- function(df_prov){

  df_prov <- df_prov %>% arrange(Date)

  # 因变量：对数价格，减小异方差
  y <- log(df_prov$Gasoline_Price)

  # 外生变量矩阵（xreg）
  xreg <- as.matrix(df_prov %>%
                      transmute(
                        Tax_cents_per_litre,
                        Crude_Oil_Price,
                        CPI_Gasoline
                      ))

  # 使用 auto.arima 让它自己选 (p,d,q) 和 (P,D,Q)
  fit <- auto.arima(
    y,
    xreg      = xreg,
    seasonal  = TRUE,
    stepwise  = FALSE,
    approximation = FALSE
  )

  return(fit)
}

#--------------------------------------------------
# 3. 按省份拆分数据，批量拟合 ARIMAX
#--------------------------------------------------
prov_list <- split(gas_model, gas_model$Province)

price_models <- map(prov_list, fit_arimax_one_prov)

# 现在你可以比如：
# 查看安省结果
price_models[["Ontario"]]

# 残差诊断
forecast::checkresiduals(price_models[["Ontario"]])

# 如果要取出各省的系数：
#coef_table <- map(price_models, coef) %>%
#  purrr::imap_dfr(~{
#    tibble(
#      Province = .y,
#      term     = names(.x),
#      estimate = as.numeric(.x)
#    )
#  })

#coef_table

```

```{r}
library(dplyr)
library(purrr)
library(forecast)
library(lubridate)

#------------------------------------------------------------
# 1. Prepare data
#------------------------------------------------------------
gas_cf <- gas %>%
  mutate(
    Date     = as.Date(Date),
    Province = trimws(Province)
  ) %>%
  filter(
    Province != "",
    !Province %in% c("Quebec", "Nunavut"),
    Date >= as.Date("2017-01-01"),
    Date <= as.Date("2025-09-01")
  ) %>%
  select(
    Province, Date,
    Gasoline_Price,
    Tax_cents_per_litre,
    Crude_Oil_Price,
    CPI_Gasoline
  ) %>%
  drop_na()

#------------------------------------------------------------
# 2. 构建 Counterfactual Tax：保持碳税不取消
#------------------------------------------------------------
gas_cf <- gas_cf %>%
  mutate(
    Tax_cf = if_else(
      Date >= as.Date("2025-04-01"),
      # 假设维持 2024 税率（或者你可以写公式逐年上调）
      Tax_cents_per_litre[Date == as.Date("2024-03-01")][1],
      Tax_cents_per_litre
    )
  )

#------------------------------------------------------------
# 3. 按省份拟合 ARIMAX 函数
#------------------------------------------------------------
fit_arimax_price <- function(df){

  df <- df %>% arrange(Date)

  y <- log(df$Gasoline_Price)

  xreg_train <- as.matrix(df %>%
                            transmute(
                              Tax_cents_per_litre,
                              Crude_Oil_Price,
                              CPI_Gasoline
                            ))

  fit <- auto.arima(
    y,
    xreg = xreg_train,
    seasonal = TRUE,
    stepwise = FALSE,
    approximation = FALSE
  )

  return(fit)
}

#------------------------------------------------------------
# 4. Counterfactual Forecast Function
#------------------------------------------------------------
price_cf_one_prov <- function(df){

  df <- df %>% arrange(Date)

  fit <- fit_arimax_price(df)

  # 未来区间：2025-04 到 2025-09
  future_df <- df %>% filter(Date >= as.Date("2025-04-01"))

  xreg_cf <- as.matrix(future_df %>%
                         transmute(
                           Tax_cents_per_litre = Tax_cf,
                           Crude_Oil_Price,
                           CPI_Gasoline
                         ))

  # Counterfactual Forecast
  fc <- forecast(
    fit,
    xreg = xreg_cf,
    h = nrow(future_df)
  )

  tibble(
    Province          = df$Province[1],
    Date              = future_df$Date,
    Actual_Price      = future_df$Gasoline_Price,
    CF_ln_Price       = as.numeric(fc$mean),
    CF_Price          = exp(as.numeric(fc$mean)),
    Price_Difference  = CF_Price - Actual_Price
  )
}

#------------------------------------------------------------
# 5. Run CF for all provinces
#------------------------------------------------------------
prov_list <- split(gas_cf, gas_cf$Province)

price_cf_results <- map_dfr(prov_list, price_cf_one_prov)

price_cf_results
readr::write_csv(price_cf_results, "price_cf_results_full.csv")
```